# kakeibo-app

Google Apps Script (GAS) を利用した、サーバーレスの家計簿アプリケーションです。
クレジットカードや銀行の取引明細CSVをGoogle Drive経由でインポートし、GoogleスプレッドシートをUIおよびデータベースとして使用して、家計の収支管理と資産の可視化を行います。

## 主な機能

-   **柔軟なCSVインポート**: 複数の金融機関のフォーマット（支出・収入が別々の列にある形式や、多様な日付フォーマットにも対応）を定義し、手動・自動でのインポートが可能です。
-   **高度なカテゴリ分類**: `Settings`シートで定義したキーワードに基づき、取引内容を自動でカテゴリ分けします。CSVからルールを一括更新したり、全取引を最新のルールで再分類するメンテナンス機能も搭載しています。
-   **カスタマイズ可能な月次レポート**: 指定した月の収入・支出の合計や、カテゴリ別の支出一覧を円グラフ付きで自動生成します。「投資」など、特定のカテゴリを収支計算から除外する設定も可能です。
-   **正確な総資産の可視化**: 銀行の「預金残高」と、手動で入力する「証券口座の評価額」を合算し、日々の正確な総資産の推移をグラフで確認できます。
-   **ポートフォリオ管理**: 最新の「預金・現金」と「証券」の資産バランスを円グラフで表示し、ポートフォリオを可視化します。
-   **詳細な割り勘計算**: 「割り勘（50%負担）」と「全額請求（100%負担）」のキーワードを個別に設定し、それぞれの合計額と最終的な請求額を算出。対象明細も一覧でレポート化します。

---

## セットアップ方法

### 1. Googleスプレッドシートの準備

1.  このアプリケーションの母体となる、新しいGoogleスプレッドシートを1つ作成します。

### 2. ローカル開発環境のセットアップ

本プロジェクトをローカルにクローンした後、以下の手順でセットアップを行います。

```bash
# 1. clasp（GASのCLIツール）をインストール
npm install -g @google/clasp

# 2. Googleアカウントにログイン（ブラウザが開きます）
clasp login

# 3. プロジェクトとスプレッドシートを紐付け
# まず、スプレッドシートの「拡張機能 > Apps Script」を開き、新しいスクリプトエディタのタブを開きます。
# そのページのURLから SCRIPT_ID をコピーします。
# 例: https://script.google.com/d/SCRIPT_ID/edit

# ローカルの .clasp.json ファイルを以下の内容で手動で作成または編集します。
# rootDir は clasp pull/push の起点となるディレクトリです。
# { "scriptId": "YOUR_SCRIPT_ID", "rootDir": "src" }

# 最後に、リモートのプロジェクトをローカルにダウンロードします。
clasp pull
```

### 3. アプリケーションの初期設定

1.  スプレッドシートを開き、メニューに表示される「家計簿アプリ」>「初期設定」を実行します。
2.  以下のシートが自動で作成されます。
    -   `DB_Transactions`: 全ての取引履歴が保存されるデータベース
    -   `DB_Securities`: 証券口座の評価額を手動で記録するシート
    -   `Settings`: カテゴリ分類ルールや、収支計算から除外するカテゴリを定義するシート
    -   `Settings_CsvFormats`: インポートするCSVのフォーマットを定義する設定シート
    -   `Settings_Splitwise`: 割り勘・全額請求のキーワードを定義する設定シート
    -   `Report_MonthlySummary`: 月次レポートの出力先
    -   `Report_TransactionList`: 月次取引明細の出力先
    -   `Report_AssetTransition`: 総資産推移グラフの出力先
    -   `Report_Splitwise`: 割り勘計算結果の出力先
    -   `Report_Portfolio`: 保有資産ポートフォリオの出力先

---

## 使い方

### 1. 各種設定

インポートを行う前に、自動生成された設定シートに必要な情報を入力します。

-   **`DB_Securities`シート**: お持ちの証券口座について、「日付」「証券会社名」「その日の評価額」を手動で記録します。定期的に記録することで、より正確な資産推移がグラフに反映されます。
-   **`Settings_CsvFormats`シート**: インポートしたいCSVのフォーマットを定義します。`FormatName`には、後述するGoogle Driveのフォルダ名と一致する名前をつけます。日付、内容、支出額、収入額、残高がそれぞれ何列目にあるかなどを指定します。
-   **`Settings`シート**: 「キーワード」と「カテゴリ」の対応表を作成します。また、「収支から除外するカテゴリ」列に、月次レポートの計算に含めたくないカテゴリ名（例: 投資）をリストアップします。
-   **`Settings_Splitwise`シート**: 「割り勘キーワード (50%)」と「全額請求キーワード (100%)」をそれぞれリストアップします。

### 2. 手動・自動インポート

（省略、内容は前回と同様）

### 3. レポートとメンテナンス

-   「家計簿アプリ」メニューから、以下の機能をいつでも実行できます。
    -   **月次レポートを生成**: 指定した月の収支サマリー（円グラフ付き）と取引明細を作成します。
    -   **資産推移グラフを生成**: 預金残高と証券口座の評価額を合算した、日々の総資産の推移をグラフで可視化します。
    -   **保有資産レポート**: 最新の「預金・現金」と「証券」の資産バランスを円グラフで可視化します。
    -   **割り勘計算**: 指定した月の割り勘・全額請求対象の支出を合計し、サマリーと明細を出力します。
    -   **分類ルールをCSVから更新**: Google Driveに置いたルール定義CSVファイルの最新の内容を`Settings`シートに反映します。
    -   **全取引のカテゴリを再分類**: `DB_Transactions`にある全取引のカテゴリを、`Settings`シートの最新ルールで一括更新します。
